{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "7c0ccb6c-a07f-4e51-afe8-3cbcb801645b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -40,
                    "y": 60
                },
                "z": 0
            },
            "b7121bd1-ea9b-47a3-962d-2e96eb855d8d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -153.49363921868246,
                    "y": 47.94207489691371
                },
                "z": 0
            }
        }
    },
    "Parameters": {
        "LambdaName": { "Type": "String" },
        "S3BucketName": {"Type": "String"},
        "S3CodeArchivePath": {"Type": "String"},
        "AESKey": {"Type": "String"},
        "AESIV": {"Type": "String"}
    },
    "Resources": {
        "IAMRoleInstance": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {"Fn::Join": ["", [{"Ref": "LambdaName"}, "-role"]]},
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": {
                        "Effect": "Allow",
                        "Action": ["sts:AssumeRole"],
                        "Principal": { "Service": ["lambda.amazonaws.com"] }
                    }
                },
                "Policies": [{
                    "PolicyName": "root",
                    "PolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [{
                            "Effect": "Allow",
                            "Action": ["kms:*"],
                            "Resource": "*"
                        }, {
                            "Effect": "Allow",
                            "Action": ["s3:Get*"],
                            "Resource": "arn:aws:s3:::*/*"
                        }]
                    }
                }]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b7121bd1-ea9b-47a3-962d-2e96eb855d8d"
                }
            }
        },
        "KMSKeyInstance": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": { "Fn::Join": ["", [
                    "A key to encrypt environment variables of lambda: ",
                    { "Ref": "LambdaName" }
                ]]},
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Id": "key-default-1",
                    "Statement": [{
                        "Sid": "Allow administration of the key",
                        "Effect": "Allow",
                        "Principal": { "AWS": [{
                            "Fn::Join": ["", [
                                "arn:aws:iam::",
                                { "Ref": "AWS::AccountId" },
                                ":role/",
                                { "Fn::Join": ["", [
                                    { "Ref": "LambdaName" },
                                    "-role"
                                ]]}
                            ]]},
                            { "Fn::Join": ["", [
                                "arn:aws:iam::",
                                { "Ref": "AWS::AccountId" },
                                ":root"
                            ]]}
                        ]},
                        "Action": [ "kms:*" ],
                        "Resource": "*"
                    }
                ]},
                "Tags": [
                    {
                        "Key": "Creator",
                        "Value": "Cloudformation Template"
                    }
                ]
            },
            "DependsOn": ["IAMRoleInstance"]
        },
        "LambdaInstance": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket" : { "Ref": "S3BucketName" },
                    "S3Key" : { "Ref": "S3CodeArchivePath" }
                },
                "FunctionName": { "Ref": "LambdaName" },
                "Description": "Lambda, created from stack, to monitor endpoints.",
                "Environment": {
                    "Variables": {
                        "AES_KEY": { "Ref": "AESKey" },
                        "AES_IV": { "Ref": "AESIV" }
                    }
                },
                "Role": {"Fn::Join": ["", [
                    "arn:aws:iam::",
                    {"Ref": "AWS::AccountId"},
                    ":role/",
                    {"Fn::Join": ["", [
                        {"Ref": "LambdaName"},
                        "-role"
                    ]]}
                ]]},
                "Handler": "script.main",
                "Runtime": "python3.6",
                "MemorySize": 192,
                "Timeout": "30",
                "KmsKeyArn": {"Fn::GetAtt": ["KMSKeyInstance", "Arn"]}
            },
            
            "DependsOn": ["IAMRoleInstance", "KMSKeyInstance"],
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "7c0ccb6c-a07f-4e51-afe8-3cbcb801645b"
                }
            }
        }
    },
    "Outputs": {
        "LambdaName": {
            "Description": "Name of created AWS Lambda function.",
            "Value": {"Fn::GetAtt": ["LambdaInstance", "Arn"]}
        },
        "LambdaAttachedRoleName": {
            "Description": "Name of attached role to AWS Lambda function.",
            "Value": {"Fn::GetAtt": ["IAMRoleInstance", "Arn"]}
        },
        "LambdaAttachedKMSKey": {
            "Description": "Name of attached KMS Key to AWS Lambda function.",
            "Value": {"Fn::GetAtt": ["KMSKeyInstance", "Arn"]}
        }
    }
}
